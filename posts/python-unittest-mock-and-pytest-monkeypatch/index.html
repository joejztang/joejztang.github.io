<!doctype html><html lang=en><head><title>python unittest mock and pytest monkeypatch · 130l</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="130l"><meta name=description content="
  What is mock/monkeypatch?
  
    
    Link to heading
  

mock and monkeypatch is heavily used on unittest where people avoid actual network calls, i/o calls, etc.
This is so useful that people use unittest should know and use it freely without any difficulties.

  Issues
  
    
    Link to heading
  

I would like to use mock, but when project is becoming really large, suddenly mock doesn&rsquo;t work! (amazing isn&rsquo;t it? but it&rsquo;s not mock, it&rsquo;s purely me.)"><meta name=keywords content="blog,science,technology,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="python unittest mock and pytest monkeypatch"><meta name=twitter:description content="What is mock/monkeypatch? Link to heading mock and monkeypatch is heavily used on unittest where people avoid actual network calls, i/o calls, etc.
This is so useful that people use unittest should know and use it freely without any difficulties.
Issues Link to heading I would like to use mock, but when project is becoming really large, suddenly mock doesn’t work! (amazing isn’t it? but it’s not mock, it’s purely me.)"><meta property="og:url" content="https://joejztang.github.io/posts/python-unittest-mock-and-pytest-monkeypatch/"><meta property="og:site_name" content="130l"><meta property="og:title" content="python unittest mock and pytest monkeypatch"><meta property="og:description" content="What is mock/monkeypatch? Link to heading mock and monkeypatch is heavily used on unittest where people avoid actual network calls, i/o calls, etc.
This is so useful that people use unittest should know and use it freely without any difficulties.
Issues Link to heading I would like to use mock, but when project is becoming really large, suddenly mock doesn’t work! (amazing isn’t it? but it’s not mock, it’s purely me.)"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-03-30T17:28:40+00:00"><meta property="article:modified_time" content="2021-03-30T17:28:40+00:00"><meta property="article:tag" content="Mock"><meta property="article:tag" content="Pytest"><link rel=canonical href=https://joejztang.github.io/posts/python-unittest-mock-and-pytest-monkeypatch/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.4b392a85107b91dbdabc528edf014a6ab1a30cd44cafcd5325c8efe796794fca.css integrity="sha256-SzkqhRB7kdvavFKO3wFKarGjDNRMr81TJcjv55Z5T8o=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/img/favicon.svg sizes=any><link rel=icon type=image/png href=/img/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/img/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://joejztang.github.io/>130l
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>Posts</a></li><li class=navigation-item><a class=navigation-link href=/about/>About</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://joejztang.github.io/posts/python-unittest-mock-and-pytest-monkeypatch/>python unittest mock and pytest monkeypatch</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2021-03-30T17:28:40Z>March 30, 2021
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
3-minute read</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/mock/>Mock</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/pytest/>Pytest</a></span></div></div></header><div class=post-content><h2 id=what-is-mockmonkeypatch>What is mock/monkeypatch?
<a class=heading-link href=#what-is-mockmonkeypatch><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p><code>mock</code> and <code>monkeypatch</code> is heavily used on unittest where people avoid actual network calls, i/o calls, etc.</p><p>This is so useful that people use unittest should know and use it freely without any difficulties.</p><h2 id=issues>Issues
<a class=heading-link href=#issues><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>I would like to use mock, but when project is becoming really large, suddenly mock doesn&rsquo;t work! (amazing isn&rsquo;t it? but it&rsquo;s not mock, it&rsquo;s purely me.)</p><p>Being specific, in large project, when I use <code>monkeypatch</code> to <code>setattr</code>, I found it is not getting patched! How come???</p><h2 id=example>Example
<a class=heading-link href=#example><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#8b949e;font-style:italic># foo.py</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>foo</span>():
</span></span><span style=display:flex><span>    print(<span style=color:#a5d6ff>&#34;I am in foo.py&#34;</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#8b949e;font-style:italic># bar.py</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>foo</span> <span style=color:#ff7b72>import</span> foo
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>bar</span>():
</span></span><span style=display:flex><span>    print(<span style=color:#a5d6ff>&#34;inside bar&#34;</span>)
</span></span><span style=display:flex><span>    foo()
</span></span></code></pre></div><p>When you executing bar method, you will see:</p><p>&ldquo;inside bar&rdquo;
&ldquo;I am in foo.py&rdquo;</p><p>Now, let&rsquo;s patch it.</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#8b949e;font-style:italic># test_bar.py</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>pytest</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>bar</span> <span style=color:#ff7b72>import</span> bar
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>test_bar</span>(monkeypatch):
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># monkeypatch will be auto &#39;inject&#39; in signature</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>patch</span>():
</span></span><span style=display:flex><span>        print(<span style=color:#a5d6ff>&#34;I am in test_bar.py&#34;</span>)
</span></span><span style=display:flex><span>    monkeypatch<span style=color:#ff7b72;font-weight:700>.</span>setattr(<span style=color:#a5d6ff>&#34;foo.foo&#34;</span>, patch)
</span></span><span style=display:flex><span>    bar()
</span></span></code></pre></div><p>What you are expecting? If I am correct, you are expecting:</p><p>&ldquo;inside bar&rdquo;
&ldquo;I am in test_bar.py&rdquo;</p><p>correct???</p><p>Well, surprise, you will see:</p><p>&ldquo;inside bar&rdquo;
&ldquo;I am in foo.py&rdquo;</p><p>Again!</p><h2 id=why-is-that-and-how-to-solve-it>Why is that and how to solve it
<a class=heading-link href=#why-is-that-and-how-to-solve-it><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><blockquote><p>patch() works by (temporarily) changing the object that a name points to with another one. There can be many names pointing to any individual object, so for patching to work you must ensure that you patch the name used by the system under test.</p></blockquote><p>This is from <a href=https://docs.python.org/dev/library/unittest.mock.html#where-to-patch class=external-link target=_blank rel=noopener>where to patch</a> in unittest mock. Underlying pytest monkeypatch uses unittest mock somehow if I am remembering.</p><p>What does this mean?</p><p>It means in <code>test_bar</code> method, it&rsquo;s not <code>foo</code> module who actually calls <code>foo()</code>, it&rsquo;s <code>bar</code> module who actually calls <code>foo()</code>. Hence, it&rsquo;s making sense to do:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#8b949e;font-style:italic># test_bar.py</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>pytest</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>bar</span> <span style=color:#ff7b72>import</span> bar
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>test_bar</span>(monkeypatch):
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># monkeypatch will be auto &#39;inject&#39; in signature</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>patch</span>():
</span></span><span style=display:flex><span>        print(<span style=color:#a5d6ff>&#34;I am in test_bar.py&#34;</span>)
</span></span><span style=display:flex><span>    monkeypatch<span style=color:#ff7b72;font-weight:700>.</span>setattr(<span style=color:#a5d6ff>&#34;bar.foo&#34;</span>, patch)
</span></span><span style=display:flex><span>    bar()
</span></span></code></pre></div><p>Now if you execute, you will see:</p><p>&ldquo;inside bar&rdquo;
&ldquo;I am in test_bar.py&rdquo;</p><p>It&rsquo;s got patched!</p><p>If until now, you still haven&rsquo;t got a clue, please see <a href=https://stackoverflow.com/questions/31306080/pytest-monkeypatch-isnt-working-on-imported-function/45466846#45466846 class=external-link target=_blank rel=noopener>this</a>, people are having the same thinking as you.</p><h2 id=understanding-on-why>Understanding on why
<a class=heading-link href=#understanding-on-why><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Let&rsquo;s revisit this:</p><blockquote><p>&mldr; so for patching to work you must ensure that you patch the name used by the system under test.</p></blockquote><p>I am from Java/Csharp world, in that world, it&rsquo;s doing patching to the original stuff (if I am still remembering). It grab the <code>Interface</code> and created a <code>Mock</code> object, and test &ldquo;knows&rdquo; to use that <code>Mock</code> object when it met the same object. If thinking more, it sounds like it uses flavor of DI, I might be wrong tho.</p><p>But in python, you have to figure out who is actually calling that &ldquo;object/method&rdquo;, and you MUST patch that specific object in order to work.</p><p>Sounds less object-ish of python, isn&rsquo;t it?</p><h2 id=a-bit-word>A bit word
<a class=heading-link href=#a-bit-word><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>With more and more developing using python, I realized there is less favor of object, even everything sounds like object in the code! Maybe you will find they are all 3 layers of application, but thinking deeply are those objects singletons? transmit? Now python becomes fun isn&rsquo;t it&mldr;?</p></div><footer><div class=comments><script>let getTheme=window.localStorage&&window.localStorage.getItem("colorscheme"),themeInParams="github-light";getTheme==null&&(themeInParams!==""&&themeInParams!=="auto"?getTheme=themeInParams:getTheme=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");let theme=getTheme==="dark"?"github-dark":"github-light",s=document.createElement("script");s.src="https://utteranc.es/client.js",s.setAttribute("repo","joejztang/joejztang.github.io"),s.setAttribute("issue-term","pathname"),s.setAttribute("theme",theme),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",""),document.querySelector("div.comments").innerHTML="",document.querySelector("div.comments").appendChild(s)</script></div></footer></article></section></div><footer class=footer><section class=container>©
1990 -
2025
130l
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-YNPYVVT1S7"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-YNPYVVT1S7")}</script></body></html>